---
name: review-comment-analysis
description: PRの未解決レビューコメントを分析し、修正要否を判断する
---

PRのコードレビューアとして、未解決のレビューコメントを収集・分析し、各コメントが妥当かどうか、修正すべきかどうかを評価した一覧を作成する。

このコマンドはコードの修正は行わず、分析と結果のファイル保存のみを行う。

**重要: このタスクは複雑な判断を伴うため、ultrathink を使用して深く思考すること。**

## 引数

`$ARGUMENTS`

- **指定あり**: その値をPR番号として使用する
- **未指定**: `gh pr view` で現在のブランチに紐づくPRを自動取得する

## 実行フロー

### 1. PR情報の取得

GitHub CLIを使用してPRの基本情報を取得する。

```bash
gh pr view [PR番号] --json number,title,body,url,headRefName,baseRefName
```

PRが見つからない場合はその旨を伝え、処理を終了する。無理に推測はしない。

### 2. レビューコメントの取得

GitHub GraphQL APIの `reviewThreads` を使用して、未解決コメント（`isResolved == false`）のみを取得する。

```graphql
query {
  repository(owner: "...", name: "...") {
    pullRequest(number: N) {
      reviewThreads(first: 100) {
        nodes {
          isResolved
          comments(first: 10) {
            nodes {
              author { login }
              body
              path
              line
              startLine
              diffHunk
              createdAt
            }
          }
        }
      }
    }
  }
}
```

未解決かどうかの判定が技術的に難しい場合は、その旨を宣言してから全コメントを対象とする。

### 3. PRの目的把握

レビューコメントを評価する前に、PRのタイトル・本文・diffを読み、以下を理解する:

- このPRが何を目的とした変更なのか（新機能、バグ修正、リファクタリング等）
- PRの前提条件やスコープ
- 既存のコーディングスタイルや設計パターン

これらの理解に基づいて、各コメントがPRの意図と整合しているかも判断材料に含める。

### 4. コメントの分析

各コメントについて以下の観点で評価する:

- 指摘内容が技術的に正しいか
- PRの目的・スコープに照らして妥当か
- プロジェクトの方針や既存の書き方と整合しているか

## 出力フォーマット

最初にサマリーテーブルを出力し、その後各コメントの詳細を記載する。

### サマリー

```markdown
## サマリー

| 判定 | 件数 |
|------|------|
| MUST_FIX | N |
| SHOULD_CONSIDER | N |
| CAN_IGNORE | N |
```

### 各コメントの詳細

```markdown
## N. [簡潔なタイトル]

| 項目 | 内容 |
|------|------|
| レビュアー | @username |
| 位置 | `ファイルパス` (行番号) |
| 種別 | bug / spec / perf / security / test / style / 好み |
| 判定 | **MUST_FIX** / **SHOULD_CONSIDER** / **CAN_IGNORE** |

**原文**:
> レビューコメントの原文をそのまま引用

**返信**:（返信がある場合のみ記載）
> **@username**: 返信内容をそのまま引用
>
> **@username**: 続く返信があれば同様に引用

**要旨**: コメントが何を指摘しているかを簡潔に記載

**理由**: なぜその判定にしたかを1〜3文で説明。PR本文の目的や前提、既存の設計との整合性にも言及する。

**返信案**: レビューコメントへの返信文章。Copilot、Codex、GeminiなどのAIエージェントがレビューしたものには敬語は使用せずPRメモのような簡潔でフォーマルな文体で記述する。
```

## 判定基準

| 判定 | 意味 | 例 |
|------|------|-----|
| MUST_FIX | 必ず修正すべき問題 | バグ、セキュリティ脆弱性、データ破損の可能性 |
| SHOULD_CONSIDER | 妥当な指摘だが検証・検討が必要 | パフォーマンス懸念、エッジケース、設計上の考慮点 |
| CAN_IGNORE | 修正不要または好みの問題 | コーディングスタイルの好み、PR作成者自身のメモ |

## ファイル保存

分析完了後、結果を `documents/review-decisions-pr-<PR番号>.md` に自動保存する。
保存後、パスを簡潔に報告する。

## 制約事項

- **コード修正は行わない**: 分析結果のファイル保存を除き、コードの変更は一切行わない。修正の提案は可能だが、実際の変更はユーザーの明示的な指示があるまで行わない。
- **情報不足時の対応**: PRやコメントの情報が不十分で判断が難しい場合は、その旨を「理由」に明記したうえで最も妥当と思われる判定を選ぶ。どうしても判定不能な場合は「情報不足で判定困難」と明示する。

